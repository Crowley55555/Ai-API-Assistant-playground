{% extends 'base.html' %}
{% load model_tags %}
{% load static %}

{% block title %}Playground - AI Playground{% endblock %}

<!-- CSRF токен загружается из base.html -->

{% block extra_css %}
<style>
/* Стилизация карточек для светлой темы */
[data-bs-theme="light"] .card {
    background-color: rgba(255, 255, 255, 0.95);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

[data-bs-theme="light"] .card-header {
    background-color: rgba(248, 249, 250, 0.95);
    border-bottom: 1px solid rgba(0, 0, 0, 0.125);
}

/* Стилизация карточек для темной темы */
[data-bs-theme="dark"] .card {
    background-color: rgba(33, 37, 41, 0.95);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

[data-bs-theme="dark"] .card-header {
    background-color: rgba(52, 58, 64, 0.95);
    border-bottom: 1px solid rgba(255, 255, 255, 0.125);
}

/* Стилизация сообщений */
[data-bs-theme="light"] .bg-primary {
    background-color: #0d6efd !important;
}

[data-bs-theme="dark"] .bg-primary {
    background-color: #0a58ca !important;
}

[data-bs-theme="light"] .bg-light {
    background-color: #f8f9fa !important;
}

[data-bs-theme="dark"] .bg-light {
    background-color: #343a40 !important;
    color: #f8f9fa !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid vh-100 d-flex flex-column p-3" x-data="playgroundApp()" x-init="init()">
    <div class="row flex-grow-1 g-3">
        <!-- Settings Card -->
        <div class="col-lg-3 col-md-4">
            <div class="card h-100 border rounded-3">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#assistant1" type="button">
                                Ассистент 1
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#assistant2" type="button">
                                Ассистент 2
                            </button>
                        </li>
                        <li class="nav-item" x-show="compare2Mode">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#assistant3" type="button">
                                Ассистент 3
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body overflow-auto">
                    <div class="tab-content">
                        <!-- Assistant 1 Settings -->
                        <div class="tab-pane fade show active" id="assistant1">
                            <div class="mb-3">
                                <label class="form-label">Модель ИИ</label>
                                <select class="form-select" x-model="settings.model" @change="updateAllSessions()">
                                    {% model_options %}
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">
                                    Температура: <span x-text="settings.temperature"></span>
                                </label>
                                <input type="range" class="form-range" min="0" max="2" step="0.01" 
                                       x-model="settings.temperature" @input="updateAllSessions()">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">
                                    Top P: <span x-text="settings.top_p"></span>
                                </label>
                                <input type="range" class="form-range" min="0" max="1" step="0.01" 
                                       x-model="settings.top_p" @input="updateAllSessions()">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">
                                    Макс. токенов: <span x-text="settings.max_tokens"></span>
                                </label>
                                <input type="range" class="form-range" min="100" max="8000" step="100" 
                                       x-model="settings.max_tokens" @input="updateAllSessions()">
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" 
                                           x-model="settings.web_search" 
                                           @change="updateAllSessions()"
                                           id="webSearch1">
                                    <label class="form-check-label" for="webSearch1">
                                        <i class="bi bi-search"></i> Поиск
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Системный промпт</label>
                                <div class="d-flex gap-2 mb-2">
                                    <button type="button" class="btn btn-outline-success btn-sm" @click="saveSystemPrompt()">
                                        <i class="bi bi-save"></i> Сохранить в ассистенте
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" @click="loadSystemPrompt()">
                                        <i class="bi bi-arrow-clockwise"></i> Загрузить из ассистента
                                    </button>
                                    <button type="button" class="btn btn-outline-danger btn-sm" @click="clearSystemPrompt()">
                                        <i class="bi bi-trash"></i> Очистить
                                    </button>
                                </div>
                                <textarea class="form-control" rows="4" x-model="settings.system_prompt" 
                                          @input="updateAllSessions()"
                                          placeholder="Введите системный промпт для ассистента..."></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Python функции</label>
                                <div class="d-flex gap-2 mb-2">
                                    <button type="button" class="btn btn-outline-info btn-sm" @click="showAddFunctionModal = true">
                                        <i class="bi bi-plus-circle"></i> Добавить функцию
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" @click="clearFunctions()">
                                        <i class="bi bi-trash"></i> Очистить
                                    </button>
                                </div>
                                <div class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                                    <div x-show="currentFunctions.length === 0" class="text-muted small">
                                        Нет добавленных функций. Нажмите "Добавить функцию" для создания.
                                    </div>
                                    <template x-for="(func, index) in currentFunctions" :key="index">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <div>
                                                <strong x-text="func.name"></strong>
                                                <small class="text-muted d-block" x-text="func.description || 'Без описания'"></small>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-danger" @click="removeFunction(index)">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Загрузка файлов</label>
                                <div class="border rounded p-3 text-center" 
                                     @drop.prevent="handleDrop($event)" 
                                     @dragover.prevent="dragOver = true"
                                     @dragleave.prevent="dragOver = false"
                                     :class="{ 'bg-light': dragOver }">
                                    <input type="file" id="fileInput" class="d-none" 
                                           @change="handleFileSelect($event)" 
                                           accept=".txt,.py,.pdf,.jpg,.jpeg,.png,.gif">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" 
                                            @click="document.getElementById('fileInput').click()">
                                        <i class="bi bi-paperclip"></i> Выбрать файл
                                    </button>
                                    <p class="small text-muted mt-2 mb-0">или перетащите файл сюда</p>
                                    <small class="text-muted">Поддерживаются: .txt (текст), .py (Python), .pdf (документы), .jpg/.jpeg/.png/.gif (изображения)</small>
                                    
                                    <!-- Список загруженных файлов -->
                                    <div class="mt-3" x-show="uploadedFiles.length > 0">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-folder-check text-success me-2"></i>
                                                <span class="fw-bold text-dark">Загруженные файлы</span>
                                                <span class="badge bg-success ms-2" x-text="uploadedFiles.length"></span>
                                            </div>
                                            <button type="button" class="btn btn-outline-danger btn-sm" @click="clearAllFiles()">
                                                <i class="bi bi-trash"></i> Очистить все
                                            </button>
                                        </div>
                                        <div class="row g-2" style="max-height: 150px; overflow-y: auto;">
                                            <template x-for="file in uploadedFiles" :key="file.id + '_' + (file.filename || '')">
                                                <div class="col-12">
                                                    <div class="card border-0 shadow-sm" 
                                                         :class="{
                                                             'border-success': file.status === 'ready',
                                                             'border-warning': file.status === 'processing',
                                                             'border-danger': file.status === 'error'
                                                         }">
                                                        <div class="card-body p-2">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <div class="d-flex align-items-center flex-grow-1">
                                                                    <div class="me-3">
                                                                        <i class="bi bi-file-earmark-text text-primary fs-5" 
                                                                           x-show="file.file_type === 'text'"></i>
                                                                        <i class="bi bi-file-code text-info fs-5" 
                                                                           x-show="file.file_type === 'code'"></i>
                                                                        <i class="bi bi-file-pdf text-danger fs-5" 
                                                                           x-show="file.file_type === 'pdf'"></i>
                                                                        <i class="bi bi-file-image text-success fs-5" 
                                                                           x-show="file.file_type === 'image'"></i>
                                                                        <i class="bi bi-file-earmark fs-5 text-secondary" 
                                                                           x-show="!['text', 'code', 'pdf', 'image'].includes(file.file_type)"></i>
                                                                    </div>
                                                                    <div class="flex-grow-1">
                                                                        <div class="fw-bold text-dark small" x-ref="filename-{{ file.id }}" x-text="file.filename"></div>
                                                                        <div class="text-muted" style="font-size: 0.75rem;">
                                                                            <span x-show="file.file_type === 'text'">Текстовый файл</span>
                                                                            <span x-show="file.file_type === 'code'">Код Python</span>
                                                                            <span x-show="file.file_type === 'pdf'">PDF документ</span>
                                                                            <span x-show="file.file_type === 'image'">Изображение</span>
                                                                            <span x-show="!['text', 'code', 'pdf', 'image'].includes(file.file_type)">Файл</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="d-flex align-items-center">
                                                                    <span class="badge bg-success me-2" x-show="file.status === 'ready'">
                                                                        <i class="bi bi-check-circle"></i> Готов
                                                                    </span>
                                                                    <span class="badge bg-warning me-2" x-show="file.status === 'processing'">
                                                                        <i class="bi bi-hourglass-split"></i> Загрузка
                                                                    </span>
                                                                    <span class="badge bg-danger me-2" x-show="file.status === 'error'">
                                                                        <i class="bi bi-x-circle"></i> Ошибка
                                                                    </span>
                                                                    <button type="button" class="btn btn-outline-danger btn-sm" 
                                                                            @click="removeFile(file.id)" title="Удалить файл">
                                                                        <i class="bi bi-x"></i>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3" x-show="sessionStats">
                                <label class="form-label">Статистика</label>
                                <div class="row text-center">
                                    <div class="col-6">
                                        <small class="text-muted">Токены</small>
                                        <div class="fw-bold" x-text="sessionStats?.total_tokens || 0"></div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Стоимость</small>
                                        <div class="fw-bold" x-text="'$' + (sessionStats?.total_estimated_cost?.toFixed(6) || '0.000000')"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-grid">
                                <button class="btn btn-outline-primary" @click="applySettingsToBoth()">
                                    <i class="bi bi-arrow-left-right"></i> Применить ко всем чатам
                                </button>
                            </div>
                        </div>
                        
                        <!-- Assistant 2 Settings -->
                        <div class="tab-pane fade" id="assistant2">
                            <div class="mb-3">
                                <label class="form-label">Модель ИИ</label>
                                <select class="form-select" x-model="compareSettings.model" @change="updateCompareSessionSettings()">
                                    {% model_options %}
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">
                                    Температура: <span x-text="compareSettings.temperature"></span>
                                </label>
                                <input type="range" class="form-range" min="0" max="2" step="0.01" 
                                       x-model="compareSettings.temperature" @input="updateCompareSessionSettings()">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">
                                    Top P: <span x-text="compareSettings.top_p"></span>
                                </label>
                                <input type="range" class="form-range" min="0" max="1" step="0.01" 
                                       x-model="compareSettings.top_p" @input="updateCompareSessionSettings()">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">
                                    Макс. токенов: <span x-text="compareSettings.max_tokens"></span>
                                </label>
                                <input type="range" class="form-range" min="100" max="8000" step="100" 
                                       x-model="compareSettings.max_tokens" @input="updateCompareSessionSettings()">
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" 
                                           x-model="compareSettings.web_search" 
                                           @change="updateCompareSessionSettings()"
                                           id="webSearch2">
                                    <label class="form-check-label" for="webSearch2">
                                        <i class="bi bi-search"></i> Поиск
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Системный промпт</label>
                                <div class="d-flex gap-2 mb-2">
                                    <button type="button" class="btn btn-outline-success btn-sm" @click="saveSystemPrompt2()">
                                        <i class="bi bi-save"></i> Сохранить в ассистенте
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" @click="loadSystemPrompt2()">
                                        <i class="bi bi-arrow-clockwise"></i> Загрузить из ассистента
                                    </button>
                                    <button type="button" class="btn btn-outline-danger btn-sm" @click="clearSystemPrompt2()">
                                        <i class="bi bi-trash"></i> Очистить
                                    </button>
                                </div>
                                <textarea class="form-control" rows="4" x-model="compareSettings.system_prompt" 
                                          placeholder="Введите системный промпт для ассистента..."></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Загрузка файлов</label>
                                <div class="border rounded p-3 text-center" 
                                     @drop.prevent="handleCompareDrop($event)" 
                                     @dragover.prevent="dragOver = true"
                                     @dragleave.prevent="dragOver = false"
                                     :class="{ 'bg-light': dragOver }">
                                    <input type="file" id="fileInput2" class="d-none" 
                                           @change="handleCompareFileSelect($event)" 
                                           accept=".txt,.py,.pdf,.jpg,.jpeg,.png,.gif">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" 
                                            @click="document.getElementById('fileInput2').click()">
                                        <i class="bi bi-paperclip"></i> Выбрать файл
                                    </button>
                                    <p class="small text-muted mt-2 mb-0">или перетащите файл сюда</p>
                                    <small class="text-muted">Поддерживаются: .txt (текст), .py (Python), .pdf (документы), .jpg/.jpeg/.png/.gif (изображения)</small>
                                    
                                    <!-- Список загруженных файлов для сравнения -->
                                    <div class="mt-3" x-show="compareUploadedFiles.length > 0">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-folder-check text-success me-2"></i>
                                                <span class="fw-bold text-dark">Загруженные файлы</span>
                                                <span class="badge bg-success ms-2" x-text="compareUploadedFiles.length"></span>
                                            </div>
                                            <button type="button" class="btn btn-outline-danger btn-sm" @click="clearAllCompareFiles()">
                                                <i class="bi bi-trash"></i> Очистить все
                                            </button>
                                        </div>
                                        <div class="row g-2" style="max-height: 150px; overflow-y: auto;">
                                            <template x-for="file in compareUploadedFiles" :key="file.id + '_' + (file.filename || '')">
                                                <div class="col-12">
                                                    <div class="card border-0 shadow-sm" 
                                                         :class="{
                                                             'border-success': file.status === 'ready',
                                                             'border-warning': file.status === 'processing',
                                                             'border-danger': file.status === 'error'
                                                         }">
                                                        <div class="card-body p-2">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <div class="d-flex align-items-center flex-grow-1">
                                                                    <div class="me-3">
                                                                        <i class="bi bi-file-earmark-text text-primary fs-5" 
                                                                           x-show="file.file_type === 'text'"></i>
                                                                        <i class="bi bi-file-code text-info fs-5" 
                                                                           x-show="file.file_type === 'code'"></i>
                                                                        <i class="bi bi-file-pdf text-danger fs-5" 
                                                                           x-show="file.file_type === 'pdf'"></i>
                                                                        <i class="bi bi-file-image text-success fs-5" 
                                                                           x-show="file.file_type === 'image'"></i>
                                                                        <i class="bi bi-file-earmark fs-5 text-secondary" 
                                                                           x-show="!['text', 'code', 'pdf', 'image'].includes(file.file_type)"></i>
                                                                    </div>
                                                                    <div class="flex-grow-1">
                                                                        <div class="fw-bold text-dark small" x-ref="filename-{{ file.id }}" x-text="file.filename"></div>
                                                                        <div class="text-muted" style="font-size: 0.75rem;">
                                                                            <span x-show="file.file_type === 'text'">Текстовый файл</span>
                                                                            <span x-show="file.file_type === 'code'">Код Python</span>
                                                                            <span x-show="file.file_type === 'pdf'">PDF документ</span>
                                                                            <span x-show="file.file_type === 'image'">Изображение</span>
                                                                            <span x-show="!['text', 'code', 'pdf', 'image'].includes(file.file_type)">Файл</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="d-flex align-items-center">
                                                                    <span class="badge bg-success me-2" x-show="file.status === 'ready'">
                                                                        <i class="bi bi-check-circle"></i> Готов
                                                                    </span>
                                                                    <span class="badge bg-warning me-2" x-show="file.status === 'processing'">
                                                                        <i class="bi bi-hourglass-split"></i> Загрузка
                                                                    </span>
                                                                    <span class="badge bg-danger me-2" x-show="file.status === 'error'">
                                                                        <i class="bi bi-x-circle"></i> Ошибка
                                                                    </span>
                                                                    <button type="button" class="btn btn-outline-danger btn-sm" 
                                                                            @click="removeCompareFile(file.id)" title="Удалить файл">
                                                                        <i class="bi bi-x"></i>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3" x-show="compareSessionStats">
                                <label class="form-label">Статистика</label>
                                <div class="row text-center">
                                    <div class="col-6">
                                        <small class="text-muted">Токены</small>
                                        <div class="fw-bold" x-text="compareSessionStats?.total_tokens || 0"></div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Стоимость</small>
                                        <div class="fw-bold" x-text="'$' + (compareSessionStats?.total_estimated_cost?.toFixed(6) || '0.000000')"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-grid">
                                <button class="btn btn-outline-info" @click="applySettingsFromBoth()">
                                    <i class="bi bi-arrow-left-right"></i> Скопировать из Ассистента 1
                                </button>
                            </div>
                        </div>
                        
                        <!-- Assistant 3 Settings -->
                        <div class="tab-pane fade" id="assistant3">
                            <div class="mb-3">
                                <label class="form-label">Модель</label>
                                <select class="form-select" x-model="compare2Settings.model" @change="updateCompare2SessionSettings()">
                                    {% model_options %}
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Температура: <span x-text="compare2Settings.temperature"></span></label>
                                <input type="range" class="form-range" min="0" max="2" step="0.01" x-model="compare2Settings.temperature" @input="updateCompare2SessionSettings()">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Top P: <span x-text="compare2Settings.top_p"></span></label>
                                <input type="range" class="form-range" min="0" max="1" step="0.01" x-model="compare2Settings.top_p" @input="updateCompare2SessionSettings()">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Макс. токенов: <span x-text="compare2Settings.max_tokens"></span></label>
                                <input type="range" class="form-range" min="100" max="8000" step="100" x-model="compare2Settings.max_tokens" @input="updateCompare2SessionSettings()">
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" 
                                           x-model="compare2Settings.web_search" 
                                           @change="updateCompare2SessionSettings()"
                                           id="webSearch3">
                                    <label class="form-check-label" for="webSearch3">
                                        <i class="bi bi-search"></i> Поиск
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Системный промпт</label>
                                <div class="d-flex gap-2 mb-2">
                                    <button type="button" class="btn btn-outline-success btn-sm" @click="saveSystemPrompt3()">
                                        <i class="bi bi-save"></i> Сохранить в ассистенте
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" @click="loadSystemPrompt3()">
                                        <i class="bi bi-arrow-clockwise"></i> Загрузить из ассистента
                                    </button>
                                    <button type="button" class="btn btn-outline-danger btn-sm" @click="clearSystemPrompt3()">
                                        <i class="bi bi-trash"></i> Очистить
                                    </button>
                                </div>
                                <textarea class="form-control" rows="3" x-model="compare2Settings.system_prompt" 
                                          placeholder="Введите системный промпт для ассистента..."></textarea>
                            </div>
                            
                            <!-- File Upload for Compare 2 -->
                            <div class="mb-3">
                                <label class="form-label">Загрузить файлы</label>
                                <div class="border rounded p-3 text-center" 
                                     @drop.prevent="handleCompare2Drop($event)"
                                     @dragover.prevent="dragOver = true"
                                     @dragleave.prevent="dragOver = false"
                                     :class="{ 'bg-light': dragOver }">
                                    <input type="file" 
                                           id="compare2FileInput" 
                                           class="d-none" 
                                           multiple 
                                           accept=".txt,.py,.pdf,.jpg,.jpeg,.png,.gif"
                                           @change="handleCompare2FileSelect($event)">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" 
                                            @click="document.getElementById('compare2FileInput').click()">
                                        <i class="bi bi-paperclip"></i> Выбрать файлы
                                    </button>
                                    <p class="small text-muted mt-2 mb-0">или перетащите файлы сюда</p>
                                    <small class="text-muted">Поддерживаются: .txt (текст), .py (Python), .pdf (документы), .jpg/.jpeg/.png/.gif (изображения)</small>
                                    
                                    <!-- Список загруженных файлов для сравнения 2 -->
                                    <div class="mt-3" x-show="compare2UploadedFiles.length > 0">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-folder-check text-success me-2"></i>
                                                <span class="fw-bold text-dark">Загруженные файлы</span>
                                                <span class="badge bg-success ms-2" x-text="compare2UploadedFiles.length"></span>
                                            </div>
                                            <button type="button" class="btn btn-outline-danger btn-sm" @click="clearAllCompare2Files()">
                                                <i class="bi bi-trash"></i> Очистить все
                                            </button>
                                        </div>
                                        <div class="row g-2" style="max-height: 150px; overflow-y: auto;">
                                            <template x-for="file in compare2UploadedFiles" :key="file.id + '_' + (file.filename || file.name || '')">
                                                <div class="col-12">
                                                    <div class="card border-0 shadow-sm" 
                                                         :class="{
                                                             'border-success': file.status === 'ready',
                                                             'border-warning': file.status === 'processing',
                                                             'border-danger': file.status === 'error'
                                                         }">
                                                        <div class="card-body p-2">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <div class="d-flex align-items-center flex-grow-1">
                                                                    <div class="me-3">
                                                                        <i class="bi bi-file-earmark-text text-primary fs-5" 
                                                                           x-show="file.file_type === 'text'"></i>
                                                                        <i class="bi bi-file-code text-info fs-5" 
                                                                           x-show="file.file_type === 'code'"></i>
                                                                        <i class="bi bi-file-pdf text-danger fs-5" 
                                                                           x-show="file.file_type === 'pdf'"></i>
                                                                        <i class="bi bi-file-image text-success fs-5" 
                                                                           x-show="file.file_type === 'image'"></i>
                                                                        <i class="bi bi-file-earmark fs-5 text-secondary" 
                                                                           x-show="!['text', 'code', 'pdf', 'image'].includes(file.file_type)"></i>
                                                                    </div>
                                                                    <div class="flex-grow-1">
                                                                        <div class="fw-bold text-dark small" x-ref="filename-{{ file.id }}" x-text="file.filename"></div>
                                                                        <div class="text-muted" style="font-size: 0.75rem;">
                                                                            <span x-show="file.file_type === 'text'">Текстовый файл</span>
                                                                            <span x-show="file.file_type === 'code'">Код Python</span>
                                                                            <span x-show="file.file_type === 'pdf'">PDF документ</span>
                                                                            <span x-show="file.file_type === 'image'">Изображение</span>
                                                                            <span x-show="!['text', 'code', 'pdf', 'image'].includes(file.file_type)">Файл</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="d-flex align-items-center">
                                                                    <span class="badge bg-success me-2" x-show="file.status === 'ready'">
                                                                        <i class="bi bi-check-circle"></i> Готов
                                                                    </span>
                                                                    <span class="badge bg-warning me-2" x-show="file.status === 'processing'">
                                                                        <i class="bi bi-hourglass-split"></i> Загрузка
                                                                    </span>
                                                                    <span class="badge bg-danger me-2" x-show="file.status === 'error'">
                                                                        <i class="bi bi-x-circle"></i> Ошибка
                                                                    </span>
                                                                    <button type="button" class="btn btn-outline-danger btn-sm" 
                                                                            @click="removeCompare2File(file.id)" title="Удалить файл">
                                                                        <i class="bi bi-x"></i>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Token Stats for Compare 2 -->
                            <div x-show="compare2SessionStats" class="mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">Статистика токенов</h6>
                                        <div class="row text-center">
                                            <div class="col-4">
                                                <small class="text-muted">Входящие</small>
                                                <div class="fw-bold" x-text="compare2SessionStats?.total_input_tokens || 0"></div>
                                            </div>
                                            <div class="col-4">
                                                <small class="text-muted">Исходящие</small>
                                                <div class="fw-bold" x-text="compare2SessionStats?.total_output_tokens || 0"></div>
                                            </div>
                                            <div class="col-4">
                                                <small class="text-muted">Стоимость</small>
                                                <div class="fw-bold" x-text="'$' + (compare2SessionStats?.total_estimated_cost?.toFixed(6) || '0.000000')"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-grid">
                                <button class="btn btn-outline-info" @click="applySettingsFromCompare2()">
                                    <i class="bi bi-arrow-left-right"></i> Скопировать из Ассистента 1
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chat Area -->
        <div :class="compareMode ? 'col-lg-9 col-md-8' : 'col-lg-9 col-md-8'">
            <div class="row h-100 g-3">
                <!-- Main Chat -->
                <div :class="compare2Mode ? 'col-md-4' : (compareMode ? 'col-md-6' : 'col-12')">
                    <div class="card h-100 border rounded-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="bi bi-chat-dots"></i> Чат 1
                            </h6>
                            <div>
                                <button class="btn btn-sm btn-success me-2" @click="showSaveAgentModal1 = true">
                                    <i class="bi bi-save"></i> Сохранить ассистента
                                </button>
                                <span class="badge bg-primary" x-text="settings.model"></span>
                                <div class="btn-group btn-group-sm ms-2">
                                    <button class="btn btn-outline-primary" @click="toggleCompare()">
                                        <i class="bi bi-arrow-left-right"></i>
                                        <span x-text="compareMode ? 'Скрыть 2' : 'Чат 2'"></span>
                                    </button>
                                    <button class="btn btn-outline-secondary" @click="toggleCompare2()" x-show="compareMode">
                                        <span x-text="compare2Mode ? 'Скрыть 3' : 'Чат 3'"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body overflow-auto" id="chatMessages1" style="max-height: calc(100vh - 300px);">
                            <template x-for="message in messages" :key="message.id">
                                <div class="mb-3">
                                    <div class="card border rounded-3" :class="message.role === 'user' ? 'bg-primary text-white' : 'bg-light'">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <strong x-text="message.role === 'user' ? 'Вы' : 'Ассистент'"></strong>
                                                <div>
                                                    <small class="me-2" x-text="formatTime(message.timestamp)"></small>
                                                    <div class="btn-group btn-group-sm" x-show="message.role === 'user'">
                                                        <button class="btn btn-sm btn-outline-secondary" @click="editMessage(message.id)">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-danger" @click="deleteMessage(message.id)">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div x-html="formatMessage(message.content)"></div>
                                            <div x-show="message.role === 'assistant' && message.token_stats" class="mt-2 pt-2 border-top">
                                                <small>
                                                    Токены: <span x-text="message.token_stats?.total_tokens"></span> | 
                                                    Стоимость: $<span x-text="message.token_stats?.estimated_cost?.toFixed(6)"></span>
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            
                            <!-- Индикатор загрузки для чата 1 -->
                            <div x-show="isLoading" class="mb-3">
                                <div class="card border rounded-3 bg-light">
                                    <div class="card-body d-flex align-items-center">
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                        <span class="text-muted">ИИ генерирует ответ...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Compare Chat -->
                <div :class="compare2Mode ? 'col-md-4' : 'col-md-6'" x-show="compareMode">
                    <div class="card h-100 border rounded-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="bi bi-chat-dots"></i> Чат 2
                            </h6>
                            <div>
                                <button class="btn btn-sm btn-success me-2" @click="showSaveAgentModal2 = true">
                                    <i class="bi bi-save"></i> Сохранить ассистента
                                </button>
                                <span class="badge bg-info" x-text="compareSettings.model"></span>
                            </div>
                        </div>
                        <div class="card-body overflow-auto" id="chatMessages2" style="max-height: calc(100vh - 300px);">
                            <template x-for="message in compareMessages" :key="message.id">
                                <div class="mb-3">
                                    <div class="card border rounded-3" :class="message.role === 'user' ? 'bg-primary text-white' : 'bg-light'">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <strong x-text="message.role === 'user' ? 'Вы' : 'Ассистент'"></strong>
                                                <div>
                                                    <small class="me-2" x-text="formatTime(message.timestamp)"></small>
                                                    <div class="btn-group btn-group-sm" x-show="message.role === 'user'">
                                                        <button class="btn btn-sm btn-outline-secondary" @click="editCompareMessage(message.id)">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-danger" @click="deleteCompareMessage(message.id)">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div x-html="formatMessage(message.content)"></div>
                                            <div x-show="message.role === 'assistant' && message.token_stats" class="mt-2 pt-2 border-top">
                                                <small>
                                                    Токены: <span x-text="message.token_stats?.total_tokens"></span> | 
                                                    Стоимость: $<span x-text="message.token_stats?.estimated_cost?.toFixed(6)"></span>
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            
                            <!-- Индикатор загрузки для чата 2 -->
                            <div x-show="compareLoading" class="mb-3">
                                <div class="card border rounded-3 bg-light">
                                    <div class="card-body d-flex align-items-center">
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                        <span class="text-muted">ИИ генерирует ответ...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Compare Chat 2 (Third Chat) -->
                <div class="col-md-4" x-show="compare2Mode">
                    <div class="card h-100 border rounded-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="bi bi-chat-dots"></i> Чат 3
                            </h6>
                            <div>
                                <button class="btn btn-sm btn-success me-2" @click="showSaveAgentModal3 = true">
                                    <i class="bi bi-save"></i> Сохранить ассистента
                                </button>
                                <span class="badge bg-warning" x-text="compare2Settings.model"></span>
                            </div>
                        </div>
                        <div class="card-body overflow-auto" id="chatMessages3" style="max-height: calc(100vh - 300px);">
                            <template x-for="message in compare2Messages" :key="message.id">
                                <div class="mb-3">
                                    <div class="card border rounded-3" :class="message.role === 'user' ? 'bg-primary text-white' : 'bg-light'">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <strong x-text="message.role === 'user' ? 'Вы' : 'Ассистент'"></strong>
                                                <div>
                                                    <small class="me-2" x-text="formatTime(message.timestamp)"></small>
                                                    <div class="btn-group btn-group-sm" x-show="message.role === 'user'">
                                                        <button class="btn btn-sm btn-outline-secondary" @click="editCompare2Message(message.id)">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-danger" @click="deleteCompare2Message(message.id)">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div x-html="formatMessage(message.content)"></div>
                                            <div x-show="message.role === 'assistant' && message.token_stats" class="mt-2 pt-2 border-top">
                                                <small>
                                                    Токены: <span x-text="message.token_stats?.total_tokens"></span> | 
                                                    Стоимость: $<span x-text="message.token_stats?.estimated_cost?.toFixed(6)"></span>
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            
                            <!-- Индикатор загрузки для чата 3 -->
                            <div x-show="compare2Loading" class="mb-3">
                                <div class="card border rounded-3 bg-light">
                                    <div class="card-body d-flex align-items-center">
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                        <span class="text-muted">ИИ генерирует ответ...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Input Area -->
    <div class="row mt-3">
        <div :class="(compareMode || compare2Mode) && !applyToBoth ? (compare2Mode ? 'col-md-4' : 'col-md-6') : 'col-12'">
            <div class="card border rounded-3">
                <div class="card-body">
                    <div class="mb-2">
                        <button class="btn btn-sm btn-success" @click="newChat()">
                            <i class="bi bi-plus-circle"></i> Новый чат
                        </button>
                        <button class="btn btn-sm btn-info ms-2" @click="toggleWebSearchForAll()" 
                                :class="{'btn-success': allWebSearchEnabled, 'btn-outline-info': !allWebSearchEnabled}">
                            <i class="bi bi-search"></i> 
                            <span x-text="allWebSearchEnabled ? 'Поиск ВКЛ' : 'Поиск ВЫКЛ'"></span>
                        </button>
                        <div class="form-check form-switch d-inline-block ms-3" x-show="compareMode || compare2Mode">
                            <input class="form-check-input" type="checkbox" x-model="applyToBoth" id="applyToBoth">
                            <label class="form-check-label" for="applyToBoth">
                                Применить ко всем чатам
                            </label>
                        </div>
                    </div>
                    <div class="input-group">
                        <textarea class="form-control" rows="2" 
                                  x-model="currentMessage" 
                                  @keydown.enter="handleEnterKey($event)"
                                  placeholder="Введите ваше сообщение... (Enter для отправки, Shift+Enter для новой строки)"></textarea>
                        <button class="btn btn-primary" @click="sendMessage()" 
                                :disabled="!currentMessage.trim() || isLoading">
                            <i class="bi bi-send" x-show="!isLoading"></i>
                            <span class="spinner-border spinner-border-sm" x-show="isLoading"></span>
                            <span x-show="isLoading" class="ms-1">Генерация...</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div :class="compare2Mode ? 'col-md-4' : 'col-md-6'" x-show="compareMode && !applyToBoth">
            <div class="card border rounded-3">
                <div class="card-body">
                    <div class="mb-2">
                        <button class="btn btn-sm btn-success" @click="newCompareChat()">
                            <i class="bi bi-plus-circle"></i> Новый чат
                        </button>
                        <button class="btn btn-sm btn-info ms-2" @click="toggleWebSearchForCompare()" 
                                :class="{'btn-success': compareWebSearchEnabled, 'btn-outline-info': !compareWebSearchEnabled}">
                            <i class="bi bi-search"></i> 
                            <span x-text="compareWebSearchEnabled ? 'Поиск ВКЛ' : 'Поиск ВЫКЛ'"></span>
                        </button>
                    </div>
                    <div class="input-group">
                        <textarea class="form-control" rows="2" 
                                  x-model="compareMessage" 
                                  @keydown.ctrl.enter="sendCompareMessageDirect()"
                                  placeholder="Введите сообщение для чата 2... (Ctrl+Enter для отправки)"></textarea>
                        <button class="btn btn-info" @click="sendCompareMessageDirect()" 
                                :disabled="!compareMessage.trim() || compareLoading">
                            <i class="bi bi-send" x-show="!compareLoading"></i>
                            <span class="spinner-border spinner-border-sm" x-show="compareLoading"></span>
                            <span x-show="compareLoading" class="ms-1">Генерация...</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4" x-show="compare2Mode && !applyToBoth">
            <div class="card border rounded-3">
                <div class="card-body">
                    <div class="mb-2">
                        <button class="btn btn-sm btn-success" @click="newCompare2Chat()">
                            <i class="bi bi-plus-circle"></i> Новый чат
                        </button>
                        <button class="btn btn-sm btn-info ms-2" @click="toggleWebSearchForCompare2()" 
                                :class="{'btn-success': compare2WebSearchEnabled, 'btn-outline-info': !compare2WebSearchEnabled}">
                            <i class="bi bi-search"></i> 
                            <span x-text="compare2WebSearchEnabled ? 'Поиск ВКЛ' : 'Поиск ВЫКЛ'"></span>
                        </button>
                    </div>
                    <div class="input-group">
                        <textarea class="form-control" rows="2" 
                                  x-model="compare2Message" 
                                  @keydown.ctrl.enter="sendCompare2MessageDirect()"
                                  placeholder="Введите сообщение для чата 3... (Ctrl+Enter для отправки)"></textarea>
                        <button class="btn btn-warning" @click="sendCompare2MessageDirect()" 
                                :disabled="!compare2Message.trim() || compare2Loading">
                            <i class="bi bi-send" x-show="!compare2Loading"></i>
                            <span class="spinner-border spinner-border-sm" x-show="compare2Loading"></span>
                            <span x-show="compare2Loading" class="ms-1">Генерация...</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Backdrop -->
    <div class="modal-backdrop fade" :class="{ 'show': showSaveAgentModal1 || showSaveAgentModal2 || showSaveAgentModal3 || showAddFunctionModal }" 
         x-show="showSaveAgentModal1 || showSaveAgentModal2 || showSaveAgentModal3 || showAddFunctionModal"></div>
    
    <!-- Save Agent Modal 1 -->
    <div class="modal fade" :class="{ 'show d-block': showSaveAgentModal1 }" 
         tabindex="-1" x-show="showSaveAgentModal1"
         @click.self="showSaveAgentModal1 = false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Сохранить ассистента (Чат 1)</h5>
                    <button type="button" class="btn-close" @click="showSaveAgentModal1 = false"></button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="saveAgent1()">
                        <div class="mb-3">
                            <label class="form-label">Название ассистента</label>
                            <input type="text" class="form-control" x-model="newAgent1.name" 
                                   @input="checkAndFillAgent1()" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Описание</label>
                            <textarea class="form-control" rows="3" x-model="newAgent1.description"></textarea>
                        </div>
                        <div class="alert alert-info">
                            <strong>Настройки:</strong><br>
                            Модель: <span x-text="settings.model"></span><br>
                            Температура: <span x-text="settings.temperature"></span><br>
                            Top P: <span x-text="settings.top_p"></span><br>
                            Макс. токенов: <span x-text="settings.max_tokens"></span>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @click="showSaveAgentModal1 = false">
                        Отмена
                    </button>
                    <button type="button" class="btn btn-success" @click="saveAgent1()" :disabled="isCreatingAgent1">
                        <span x-show="!isCreatingAgent1">Сохранить</span>
                        <span x-show="isCreatingAgent1" class="spinner-border spinner-border-sm"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Save Agent Modal 2 -->
    <div class="modal fade" :class="{ 'show d-block': showSaveAgentModal2 }" 
         tabindex="-1" x-show="showSaveAgentModal2"
         @click.self="showSaveAgentModal2 = false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Сохранить ассистента (Чат 2)</h5>
                    <button type="button" class="btn-close" @click="showSaveAgentModal2 = false"></button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="saveAgent2()">
                        <div class="mb-3">
                            <label class="form-label">Название ассистента</label>
                            <input type="text" class="form-control" x-model="newAgent2.name" 
                                   @input="checkAndFillAgent2()" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Описание</label>
                            <textarea class="form-control" rows="3" x-model="newAgent2.description"></textarea>
                        </div>
                        <div class="alert alert-info">
                            <strong>Настройки:</strong><br>
                            Модель: <span x-text="compareSettings.model"></span><br>
                            Температура: <span x-text="compareSettings.temperature"></span><br>
                            Top P: <span x-text="compareSettings.top_p"></span><br>
                            Макс. токенов: <span x-text="compareSettings.max_tokens"></span>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @click="showSaveAgentModal2 = false">
                        Отмена
                    </button>
                    <button type="button" class="btn btn-success" @click="saveAgent2()" :disabled="isCreatingAgent2">
                        <span x-show="!isCreatingAgent2">Сохранить</span>
                        <span x-show="isCreatingAgent2" class="spinner-border spinner-border-sm"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Save Agent Modal 3 -->
    <div class="modal fade" :class="{ 'show d-block': showSaveAgentModal3 }" 
         tabindex="-1" x-show="showSaveAgentModal3"
         @click.self="showSaveAgentModal3 = false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Сохранить ассистента 3</h5>
                    <button type="button" class="btn-close" @click="showSaveAgentModal3 = false"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Название</label>
                        <input type="text" class="form-control" x-model="newAgent3.name" 
                               @input="checkAndFillAgent3()" placeholder="Мой ассистент">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Описание</label>
                        <textarea class="form-control" rows="3" x-model="newAgent3.description" placeholder="Описание ассистента..."></textarea>
                    </div>
                    <div class="alert alert-info">
                        <strong>Текущие настройки:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Модель: <span x-text="compare2Settings.model"></span></li>
                            <li>Температура: <span x-text="compare2Settings.temperature"></span></li>
                            <li>Top P: <span x-text="compare2Settings.top_p"></span></li>
                            <li>Макс. токенов: <span x-text="compare2Settings.max_tokens"></span></li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @click="showSaveAgentModal3 = false">Отмена</button>
                    <button type="button" class="btn btn-success" @click="saveAgent3()" :disabled="isCreatingAgent3">
                        <span x-show="!isCreatingAgent3">Сохранить</span>
                        <span x-show="isCreatingAgent3">Сохранение...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Function Modal -->
    <div class="modal fade" :class="{ 'show d-block': showAddFunctionModal }" 
         tabindex="-1" x-show="showAddFunctionModal"
         @click.self="showAddFunctionModal = false">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Добавить Python функцию</h5>
                    <button type="button" class="btn-close" @click="showAddFunctionModal = false"></button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="addFunction()">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="functionName" class="form-label">Название функции</label>
                                    <input type="text" class="form-control" id="functionName" 
                                           x-model="newFunction.name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="functionDescription" class="form-label">Описание</label>
                                    <input type="text" class="form-control" id="functionDescription" 
                                           x-model="newFunction.description">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="jsonDefinition" class="form-label">JSON определение функции</label>
                            <textarea class="form-control" id="jsonDefinition" rows="6" 
                                      x-model="newFunction.jsonDefinition" 
                                      placeholder='{
  "name": "function_name",
  "description": "Описание функции",
  "parameters": {
    "type": "object",
    "properties": {
      "param1": {
        "type": "string",
        "description": "Описание параметра"
      }
    },
    "required": ["param1"]
  }
}'></textarea>
                            <small class="form-text text-muted">
                                Определение функции в формате OpenAI Function Calling
                            </small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="pythonCode" class="form-label">Python код функции</label>
                            <textarea class="form-control" id="pythonCode" rows="8" 
                                      x-model="newFunction.pythonCode" 
                                      placeholder="def function_name(param1):
    '''
    Описание функции
    '''
    # Ваш код здесь
    result = f&quot;Обработано: {param1}&quot;
    return result"></textarea>
                            <small class="form-text text-muted">
                                Python код функции, который будет выполняться
                            </small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @click="showAddFunctionModal = false">
                        Отмена
                    </button>
                    <button type="button" class="btn btn-primary" @click="addFunction()">
                        Добавить функцию
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function playgroundApp() {
    return {
        settings: {
            model: 'GigaChat:latest',
            temperature: 0.7,
            top_p: 1.0,
            max_tokens: 4000,
            system_prompt: '',
            web_search: false
        },
        compareSettings: {
            model: 'yandexgpt',
            temperature: 0.7,
            top_p: 1.0,
            max_tokens: 4000,
            system_prompt: '',
            web_search: false
        },
        compare2Settings: {
            model: 'GigaChat:latest',
            temperature: 0.7,
            top_p: 1.0,
            max_tokens: 4000,
            system_prompt: '',
            web_search: false
        },
        sessionId: null,
        compareSessionId: null,
        compare2SessionId: null,
        messages: [],
        compareMessages: [],
        compare2Messages: [],
        // Состояние поиска для каждого чата
        allWebSearchEnabled: false,
        compareWebSearchEnabled: false,
        compare2WebSearchEnabled: false,
        currentMessage: '',
        compareMessage: '',
        showAddFunctionModal: false,
        currentFunctions: [],
        newFunction: {
            name: '',
            description: '',
            jsonDefinition: '',
            pythonCode: ''
        },
        currentAgentId: null,
        compareAgentId: null,
        compare2AgentId: null,
        compare2Message: '',
        isLoading: false,
        compareLoading: false,
        compare2Loading: false,
        compareMode: false,
        compare2Mode: false,
        applyToBoth: true,
        sessionStats: null,
        compareSessionStats: null,
        dragOver: false,
        uploadedFiles: [],
        compareUploadedFiles: [],
        compare2UploadedFiles: [],
        compareSessionStats: null,
        compare2SessionStats: null,
        showSaveAgentModal1: false,
        showSaveAgentModal2: false,
        showSaveAgentModal3: false,
        isCreatingAgent1: false,
        isCreatingAgent2: false,
        isCreatingAgent3: false,
        newAgent1: {
            name: '',
            description: ''
        },
        newAgent2: {
            name: '',
            description: ''
        },
        newAgent3: {
            name: '',
            description: ''
        },
        
        init() {
            // Глобальная обработка ошибок
            window.addEventListener('unhandledrejection', (event) => {
                console.error('Unhandled promise rejection:', event.reason);
                this.showNotification('Произошла неожиданная ошибка. Проверьте консоль.', 'error');
            });
            
            window.addEventListener('error', (event) => {
                console.error('Global error:', event.error);
                this.showNotification('Произошла ошибка JavaScript. Проверьте консоль.', 'error');
            });
            
            this.loadSession();
            this.loadAssistantFromUrl();
            
            // Задержка для проверки сети, чтобы не блокировать загрузку
            setTimeout(() => {
                this.checkNetworkConnection();
            }, 1000);
        },
        
        async checkNetworkConnection() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch('/playground/api/health/', {
                    method: 'GET',
                    signal: controller.signal,
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    this.showNotification('Подключение к серверу установлено', 'success');
                } else {
                    this.showNotification('Проблемы с подключением к серверу', 'warning');
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    this.showNotification('Таймаут подключения к серверу', 'warning');
                } else {
                    this.showNotification('Нет подключения к интернету', 'error');
                }
                console.log('Network check error:', error);
            }
        },
        
        showNotification(message, type = 'info') {
            // Создаем уведомление
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                <strong>${this.getNotificationTitle(type)}</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Автоматически скрываем через 5 секунд
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        },
        
        getNotificationTitle(type) {
            const titles = {
                'success': '✅',
                'info': 'ℹ️',
                'warning': '⚠️',
                'error': '❌'
            };
            return titles[type] || 'ℹ️';
        },
        
        getCSRFToken() {
            // Функция для получения CSRF токена из cookies
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            // Сначала пробуем найти токен в скрытом поле
            const tokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
            if (tokenElement && tokenElement.value) {
                console.log('CSRF token from input:', tokenElement.value);
                return tokenElement.value;
            }
            
            // Если не найден в поле, пробуем получить из cookies
            const token = getCookie('csrftoken');
            if (token) {
                console.log('CSRF token from cookie:', token);
                return token;
            }
            
            // Если ничего не найдено
            console.error('CSRF token not found');
            console.log('All cookies:', document.cookie);
            console.log('All hidden inputs:', document.querySelectorAll('input[type="hidden"]'));
            this.showNotification('Ошибка безопасности: CSRF токен не найден', 'error');
            return null;
        },
        
        loadAssistantFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const assistantId = urlParams.get('assistant');
            if (assistantId) {
                this.loadAssistant(assistantId);
            }
        },
        
        async loadAssistant(assistantId) {
            try {
                const response = await fetch(`/playground/api/agents/${assistantId}/`, {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': csrftoken
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    // Загружаем настройки в первый чат
                    this.settings = {
                        model: data.agent.model,
                        temperature: data.agent.temperature,
                        top_p: data.agent.top_p,
                        max_tokens: data.agent.max_tokens || 4000,
                        system_prompt: data.agent.system_prompt
                    };
                    
                    // Загружаем историю сообщений если есть
                    if (data.messages && data.messages.length > 0) {
                        this.messages = data.messages;
                    }
                }
            } catch (error) {
                console.error('Error loading assistant:', error);
            }
        },
        
        async loadSession() {
            const csrftoken = this.getCSRFToken();
            if (!csrftoken) {
                console.error('CSRF token not found in loadSession');
                return;
            }
            
            const response = await fetch('/playground/api/create-session/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    model: this.settings.model,
                    temperature: this.settings.temperature,
                    top_p: this.settings.top_p,
                    max_tokens: this.settings.max_tokens,
                    system_prompt: this.settings.system_prompt,
                    web_search: this.settings.web_search,
                    functions: this.currentFunctions
                })
            });
            const data = await response.json();
            if (data.success) {
                this.sessionId = data.session.session_id;
                console.log('Session created with model:', this.settings.model);
            } else {
                console.error('Failed to create session:', data.error);
            }
        },
        
        async updateSessionSettings() {
            try {
                // Обновляем настройки через ChatManager
                const settings = ChatFactory.createSettings(
                    this.settings.model,
                    this.settings.temperature,
                    this.settings.top_p,
                    this.settings.max_tokens,
                    this.settings.system_prompt,
                    this.settings.web_search,
                    this.currentFunctions
                );
                
                await this.chatManager.updateSettings('main', settings);
                console.log('Main session settings updated successfully');
            } catch (error) {
                console.error('Error updating session settings:', error);
            }
        },

        async updateAllSessions() {
            try {
                // Обновляем настройки для всех чатов
                const mainSettings = ChatFactory.createSettings(
                    this.settings.model,
                    this.settings.temperature,
                    this.settings.top_p,
                    this.settings.max_tokens,
                    this.settings.system_prompt,
                    this.settings.web_search,
                    this.currentFunctions
                );
                
                const compareSettings = ChatFactory.createSettings(
                    this.compareSettings.model,
                    this.compareSettings.temperature,
                    this.compareSettings.top_p,
                    this.compareSettings.max_tokens,
                    this.compareSettings.system_prompt,
                    this.compareSettings.web_search,
                    this.currentFunctions
                );
                
                const compare2Settings = ChatFactory.createSettings(
                    this.compare2Settings.model,
                    this.compare2Settings.temperature,
                    this.compare2Settings.top_p,
                    this.compare2Settings.max_tokens,
                    this.compare2Settings.system_prompt,
                    this.compare2Settings.web_search,
                    this.currentFunctions
                );
                
                // Обновляем настройки в ChatManager
                await this.chatManager.updateSettings('main', mainSettings);
                await this.chatManager.updateSettings('compare', compareSettings);
                await this.chatManager.updateSettings('compare2', compare2Settings);
                
                // Обновляем все сессии на сервере
                const results = await this.chatManager.updateAllSessions();
                console.log('All sessions updated:', results);
                
                // Синхронизируем состояние поиска
                this.allWebSearchEnabled = this.settings.web_search;
                this.compareWebSearchEnabled = this.compareSettings.web_search;
                this.compare2WebSearchEnabled = this.compare2Settings.web_search;
                
            } catch (error) {
                console.error('Error updating all sessions:', error);
            }
        },
        
        handleEnterKey(event) {
            if (event.shiftKey) {
                // Shift+Enter - разрешаем новую строку (стандартное поведение)
                return;
            } else {
                // Enter - отправляем сообщение
                event.preventDefault();
                this.sendMessage();
            }
        },
        
        async sendMessage() {
            if (!this.currentMessage.trim() || this.isLoading) return;
            
            const message = this.currentMessage.trim();
            this.currentMessage = '';
            this.isLoading = true;
            
            // Уведомление о принятии запроса
            this.showNotification('Запрос принят, отправляем на обработку...', 'info');
            
            this.scrollToBottom();
            
            try {
                // Уведомление о начале обработки
                this.showNotification('Запрос обрабатывается ИИ...', 'info');
                
                // Обновляем настройки перед отправкой сообщения
                const settings = ChatFactory.createSettings(
                    this.settings.model,
                    this.settings.temperature,
                    this.settings.top_p,
                    this.settings.max_tokens,
                    this.settings.system_prompt,
                    this.settings.web_search,
                    this.currentFunctions
                );
                
                await this.chatManager.updateSettings('main', settings);
                
                // Принудительно обновляем настройки на сервере
                await this.chatManager.forceUpdateSessionSettings('main');
                
                // Логируем настройки для отладки
                console.log('Sending message with settings:', {
                    model: this.settings.model,
                    web_search: this.settings.web_search,
                    system_prompt: this.settings.system_prompt ? 'present' : 'empty'
                });
                
                // Отправляем сообщение через ChatManager
                const assistant_message = await this.chatManager.sendMessage('main', message);
                
                // Обновляем UI
                this.messages = this.chatManager.getSession('main').messages;
                
                // Обновляем статистику
                const session = this.chatManager.getSession('main');
                if (session.stats) {
                    this.sessionStats = session.stats;
                }
                
                // Обновляем sessionId
                this.sessionId = session.session_id;
                
                // Уведомление об успешном получении ответа
                this.showNotification('Ответ получен и добавлен в чат!', 'success');
                
                // Отправляем сообщения в compare чаты
                if (this.compareMode && this.applyToBoth) {
                    await this.sendCompareMessage(message);
                }
                
                if (this.compare2Mode && this.applyToBoth) {
                    await this.sendCompare2Message(message);
                }
            } catch (error) {
                console.error('Error:', error);
                if (error.name === 'AbortError') {
                    this.showNotification('Таймаут запроса (60 сек). Попробуйте еще раз.', 'warning');
                } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    this.showNotification('Ошибка сети. Проверьте подключение к интернету.', 'error');
                } else {
                    this.showNotification('Ошибка: ' + (error.message || 'Неизвестная ошибка'), 'error');
                }
            } finally {
                this.isLoading = false;
                this.scrollToBottom();
            }
        },
        
        // Функции для управления поиском
        toggleWebSearchForAll() {
            this.allWebSearchEnabled = !this.allWebSearchEnabled;
            this.settings.web_search = this.allWebSearchEnabled;
            this.updateAllSessions();
            this.showNotification(
                this.allWebSearchEnabled ? 'Поиск включен для основного чата' : 'Поиск выключен для основного чата', 
                this.allWebSearchEnabled ? 'success' : 'info'
            );
        },
        
        toggleWebSearchForCompare() {
            this.compareWebSearchEnabled = !this.compareWebSearchEnabled;
            this.compareSettings.web_search = this.compareWebSearchEnabled;
            this.updateAllSessions();
            this.showNotification(
                this.compareWebSearchEnabled ? 'Поиск включен для второго чата' : 'Поиск выключен для второго чата', 
                this.compareWebSearchEnabled ? 'success' : 'info'
            );
        },
        
        toggleWebSearchForCompare2() {
            this.compare2WebSearchEnabled = !this.compare2WebSearchEnabled;
            this.compare2Settings.web_search = this.compare2WebSearchEnabled;
            this.updateAllSessions();
            this.showNotification(
                this.compare2WebSearchEnabled ? 'Поиск включен для третьего чата' : 'Поиск выключен для третьего чата', 
                this.compare2WebSearchEnabled ? 'success' : 'info'
            );
        },
        
        // Функции для обновления настроек сессий чатов сравнения
        async updateCompareSessionSettings() {
            if (!this.compareSessionId) return;
            
            const csrftoken = this.getCSRFToken();
            if (!csrftoken) return;
            
            try {
                const response = await fetch('/playground/api/update-session/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        session_id: this.compareSessionId,
                        model: this.compareSettings.model,
                        temperature: parseFloat(this.compareSettings.temperature),
                        top_p: parseFloat(this.compareSettings.top_p),
                        max_tokens: parseInt(this.compareSettings.max_tokens),
                        system_prompt: this.compareSettings.system_prompt,
                        web_search: this.compareSettings.web_search
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    console.log('Compare session settings updated successfully');
                }
            } catch (error) {
                console.error('Error updating compare session settings:', error);
            }
        },
        
        async updateCompare2SessionSettings() {
            if (!this.compare2SessionId) return;
            
            const csrftoken = this.getCSRFToken();
            if (!csrftoken) return;
            
            try {
                const response = await fetch('/playground/api/update-session/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        session_id: this.compare2SessionId,
                        model: this.compare2Settings.model,
                        temperature: parseFloat(this.compare2Settings.temperature),
                        top_p: parseFloat(this.compare2Settings.top_p),
                        max_tokens: parseInt(this.compare2Settings.max_tokens),
                        system_prompt: this.compare2Settings.system_prompt,
                        web_search: this.compare2Settings.web_search
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    console.log('Compare2 session settings updated successfully');
                }
            } catch (error) {
                console.error('Error updating compare2 session settings:', error);
            }
        },
        
        async sendCompareMessage(message) {
            if (!message || this.compareLoading) return;
            
            this.compareLoading = true;
            this.showNotification('Отправляем запрос во второй чат...', 'info');
            
            try {
                // Обновляем настройки перед отправкой сообщения
                const settings = ChatFactory.createSettings(
                    this.compareSettings.model,
                    this.compareSettings.temperature,
                    this.compareSettings.top_p,
                    this.compareSettings.max_tokens,
                    this.compareSettings.system_prompt,
                    this.compareSettings.web_search,
                    this.currentFunctions
                );
                
                await this.chatManager.updateSettings('compare', settings);
                
                // Принудительно обновляем настройки на сервере
                await this.chatManager.forceUpdateSessionSettings('compare');
                
                // Отправляем сообщение через ChatManager
                const assistant_message = await this.chatManager.sendMessage('compare', message);
                
                // Обновляем UI
                this.compareMessages = this.chatManager.getSession('compare').messages;
                
                // Обновляем статистику
                const session = this.chatManager.getSession('compare');
                if (session.stats) {
                    this.compareSessionStats = session.stats;
                }
                
                // Обновляем compareSessionId
                this.compareSessionId = session.session_id;
                
                this.showNotification('Ответ получен во втором чате!', 'success');
            } catch (error) {
                console.error('Compare chat error:', error);
                if (error.name === 'AbortError') {
                    this.showNotification('Таймаут запроса во втором чате (60 сек)', 'warning');
                } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    this.showNotification('Ошибка сети во втором чате. Проверьте подключение.', 'error');
                } else {
                    this.showNotification('Ошибка во втором чате: ' + (error.message || 'Неизвестная ошибка'), 'error');
                }
            } finally {
                this.compareLoading = false;
                this.scrollToBottom();
            }
        },
        
        async sendCompareMessageDirect() {
            if (!this.compareMessage.trim() || this.compareLoading) return;
            
            const message = this.compareMessage.trim();
            this.compareMessage = '';
            
            this.scrollToBottom();
            
            // Отправляем сообщение (сообщение пользователя будет добавлено в sendCompareMessage)
            await this.sendCompareMessage(message);
        },
        
        async sendCompare2Message(message) {
            if (!message || this.compare2Loading) return;
            
            const csrftoken = this.getCSRFToken();
            if (!csrftoken) {
                return;
            }
            
            this.compare2Loading = true;
            this.showNotification('Отправляем запрос в третий чат...', 'info');
            
            // Добавляем сообщение пользователя в compare2 чат
            this.compare2Messages.push({
                id: Date.now() + 0.2,
                role: 'user',
                content: message,
                timestamp: new Date().toISOString()
            });
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);
                
                // Если нет сессии для сравнения 2, создаем новую
                if (!this.compare2SessionId) {
                    const sessionResponse = await fetch('/playground/api/create-session/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken,
                            'Cache-Control': 'no-cache'
                        },
                        body: JSON.stringify({
                            model: this.compare2Settings.model,
                            temperature: this.compare2Settings.temperature,
                            top_p: this.compare2Settings.top_p,
                            max_tokens: this.compare2Settings.max_tokens,
                            system_prompt: this.compare2Settings.system_prompt,
                            web_search: this.compare2Settings.web_search,
                            functions: this.currentFunctions
                        }),
                        signal: controller.signal
                    });
                    
                    const sessionData = await sessionResponse.json();
                    if (sessionData.success) {
                        this.compare2SessionId = sessionData.session_id;
                    } else {
                        throw new Error(sessionData.error || 'Failed to create session');
                    }
                }
                
                const response = await fetch('/playground/api/send-message/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                        'Cache-Control': 'no-cache'
                    },
                    body: JSON.stringify({
                        session_id: this.compare2SessionId,
                        message: message,
                        functions: this.currentFunctions
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                const data = await response.json();
                if (data.success) {
                    this.showNotification('Ответ получен в третьем чате!', 'success');
                    this.compare2Messages.push({
                        id: Date.now() + 3,
                        role: 'assistant',
                        content: data.assistant_message.content,
                        timestamp: data.assistant_message.timestamp,
                        token_stats: data.assistant_message.token_stats
                    });
                    
                    if (data.session_stats) {
                        this.compare2SessionStats = data.session_stats;
                    }
                } else {
                    this.showNotification('Ошибка в третьем чате: ' + (data.error || 'Неизвестная ошибка'), 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                if (error.name === 'AbortError') {
                    this.showNotification('Таймаут запроса в третьем чате (60 сек)', 'warning');
                } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    this.showNotification('Ошибка сети в третьем чате. Проверьте подключение.', 'error');
                } else {
                    this.showNotification('Ошибка в третьем чате: ' + (error.message || 'Неизвестная ошибка'), 'error');
                }
            } finally {
                this.compare2Loading = false;
                this.scrollToBottom();
            }
        },
        
        async sendCompare2MessageDirect() {
            if (!this.compare2Message.trim() || this.compare2Loading) return;
            
            const message = this.compare2Message.trim();
            this.compare2Message = '';
            
            this.scrollToBottom();
            
            // Отправляем сообщение (сообщение пользователя будет добавлено в sendCompare2Message)
            await this.sendCompare2Message(message);
        },
        
        toggleCompare() {
            this.compareMode = !this.compareMode;
            if (!this.compareMode) {
                this.compareMessages = [];
                this.compareSessionStats = null;
                this.compare2Mode = false;
                this.compare2Messages = [];
                this.compare2SessionStats = null;
            }
        },
        
        toggleCompare2() {
            this.compare2Mode = !this.compare2Mode;
            if (!this.compare2Mode) {
                this.compare2Messages = [];
                this.compare2SessionStats = null;
            }
        },
        
        newChat() {
            this.messages = [];
            this.sessionStats = null;
            this.loadSession();
            this.showNotification('Новый чат создан!', 'success');
        },
        
        newCompareChat() {
            this.compareMessages = [];
            this.compareSessionStats = null;
            this.showNotification('Новый чат для сравнения создан!', 'success');
        },
        
        newCompare2Chat() {
            this.compare2Messages = [];
            this.compare2SessionStats = null;
            this.showNotification('Новый третий чат создан!', 'success');
        },
        
        editMessage(messageId) {
            const message = this.messages.find(m => m.id === messageId);
            if (message) {
                this.currentMessage = message.content;
                this.deleteMessage(messageId);
            }
        },
        
        deleteMessage(messageId) {
            this.messages = this.messages.filter(m => m.id !== messageId);
            this.showNotification('Сообщение удалено', 'info');
        },
        
        editCompareMessage(messageId) {
            const message = this.compareMessages.find(m => m.id === messageId);
            if (message) {
                this.compareMessage = message.content;
                this.deleteCompareMessage(messageId);
            }
        },
        
        deleteCompareMessage(messageId) {
            this.compareMessages = this.compareMessages.filter(m => m.id !== messageId);
            this.showNotification('Сообщение удалено из второго чата', 'info');
        },
        
        editCompare2Message(messageId) {
            const message = this.compare2Messages.find(m => m.id === messageId);
            if (message) {
                this.compare2Message = message.content;
                this.deleteCompare2Message(messageId);
            }
        },
        
        deleteCompare2Message(messageId) {
            this.compare2Messages = this.compare2Messages.filter(m => m.id !== messageId);
            this.showNotification('Сообщение удалено из третьего чата', 'info');
        },
        
        formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        },
        
        formatMessage(content) {
            return content.replace(/\n/g, '<br>');
        },
        
        scrollToBottom() {
            this.$nextTick(() => {
                const chat1 = document.getElementById('chatMessages1');
                const chat2 = document.getElementById('chatMessages2');
                const chat3 = document.getElementById('chatMessages3');
                if (chat1) chat1.scrollTop = chat1.scrollHeight;
                if (chat2) chat2.scrollTop = chat2.scrollHeight;
                if (chat3) chat3.scrollTop = chat3.scrollHeight;
            });
        },
        
        // File handling for Assistant 1
        handleFileSelect(event) {
            const files = event.target.files;
            this.uploadFiles(files, false);
        },
        
        handleDrop(event) {
            this.dragOver = false;
            const files = event.dataTransfer.files;
            this.uploadFiles(files, false);
        },
        
        // File handling for Assistant 2
        handleCompareFileSelect(event) {
            const files = event.target.files;
            this.uploadFiles(files, 'compare');
        },
        
        handleCompareDrop(event) {
            this.dragOver = false;
            const files = event.dataTransfer.files;
            this.uploadFiles(files, 'compare');
        },
        
        handleCompare2FileSelect(event) {
            const files = event.target.files;
            this.uploadFiles(files, 'compare2');
        },
        
        handleCompare2Drop(event) {
            this.dragOver = false;
            const files = event.dataTransfer.files;
            this.uploadFiles(files, 'compare2');
        },
        
        async uploadFiles(files, chatType) {
            const csrftoken = this.getCSRFToken();
            if (!csrftoken) {
                return;
            }
            
            this.showNotification(`Загружаем ${files.length} файл(ов)...`, 'info');
            
            for (let file of files) {
                // Добавляем файл со статусом "processing"
                const tempFileInfo = {
                    id: 'temp_' + Date.now() + '_' + Math.random(),
                    filename: file.name,
                    name: file.name, // Добавляем и name для совместимости
                    status: 'processing'
                };
                
                if (chatType === 'compare') {
                    this.compareUploadedFiles.push(tempFileInfo);
                } else if (chatType === 'compare2') {
                    this.compare2UploadedFiles.push(tempFileInfo);
                } else {
                    this.uploadedFiles.push(tempFileInfo);
                }
                
                // Сразу устанавливаем название файла в DOM
                this.$nextTick(() => {
                    const filenameElement = this.$refs[`filename-${tempFileInfo.id}`];
                    if (filenameElement) {
                        filenameElement.innerHTML = tempFileInfo.filename || tempFileInfo.name || 'Загрузка...';
                        console.log('Set initial filename:', filenameElement.innerHTML);
                    }
                });
                
                // Создаем sessionId если его нет
                if (!this.sessionId) {
                    this.sessionId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                }
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('session_id', this.sessionId);
                
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 секунд для загрузки файла
                    
                    const response = await fetch('/playground/api/upload-file/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken
                        },
                        body: formData,
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    const data = await response.json();
                    console.log('Response data:', data); // Отладка
                    if (data.success) {
                        const fileInfo = {
                            id: data.file.id,
                            filename: data.file.filename,
                            name: data.file.filename, // Добавляем name для совместимости
                            file_type: data.file.file_type
                        };
                        
                        console.log('Created fileInfo:', fileInfo); // Отладка
                        console.log('File filename:', fileInfo.filename); // Отладка
                        console.log('File name property:', fileInfo.name); // Отладка
                        console.log('Filename length:', fileInfo.filename ? fileInfo.filename.length : 'null');
                        console.log('Filename charCodes:', fileInfo.filename ? Array.from(fileInfo.filename).map(c => c.charCodeAt(0)) : 'null');
                        
                        // Заменяем временный файл на реальный
                        fileInfo.status = 'ready';
                        
                        if (chatType === 'compare') {
                            const index = this.compareUploadedFiles.findIndex(f => f.id === tempFileInfo.id);
                            if (index !== -1) {
                                Object.assign(this.compareUploadedFiles[index], fileInfo);
                                this.compareUploadedFiles = [...this.compareUploadedFiles];
                            }
                        } else if (chatType === 'compare2') {
                            const index = this.compare2UploadedFiles.findIndex(f => f.id === tempFileInfo.id);
                            if (index !== -1) {
                                Object.assign(this.compare2UploadedFiles[index], fileInfo);
                                this.compare2UploadedFiles = [...this.compare2UploadedFiles];
                            }
                        } else {
                            const index = this.uploadedFiles.findIndex(f => f.id === tempFileInfo.id);
                            if (index !== -1) {
                                // Принудительно обновляем объект файла
                                Object.assign(this.uploadedFiles[index], fileInfo);
                                // Триггерим обновление Alpine.js
                                this.uploadedFiles = [...this.uploadedFiles];
                                console.log('Updated uploadedFiles array:', this.uploadedFiles); // Отладка
                            }
                        }
                        
                        this.showNotification(`Файл "${fileInfo.filename}" успешно загружен!`, 'success');
                        
                        // Принудительно обновляем DOM
                        this.$nextTick(() => {
                            console.log('DOM updated, checking filename display...');
                            // Принудительно обновляем отображение filename
                            setTimeout(() => {
                                const filenameElement = this.$refs[`filename-${fileInfo.id}`];
                                if (filenameElement) {
                                    // Принудительно очищаем и устанавливаем содержимое
                                    filenameElement.textContent = '';
                                    filenameElement.textContent = fileInfo.filename || 'NO FILENAME';
                                    console.log('Force updated filename element:', filenameElement.textContent);
                                } else {
                                    console.log('Filename element not found for ID:', fileInfo.id);
                                    // Попробуем найти элемент по другому способу
                                    const allElements = document.querySelectorAll('[x-ref^="filename-"]');
                                    console.log('All filename elements found:', allElements.length);
                                    allElements.forEach(el => {
                                        if (el.getAttribute('x-ref') === `filename-${fileInfo.id}`) {
                                            el.textContent = '';
                                            el.textContent = fileInfo.filename || 'NO FILENAME';
                                            console.log('Found and updated element:', el.textContent);
                                        }
                                    });
                                }
                            }, 100);
                        });
                    } else {
                        // Обновляем статус на ошибку
                        if (chatType === 'compare') {
                            const index = this.compareUploadedFiles.findIndex(f => f.id === tempFileInfo.id);
                            if (index !== -1) {
                                this.compareUploadedFiles[index].status = 'error';
                            }
                        } else if (chatType === 'compare2') {
                            const index = this.compare2UploadedFiles.findIndex(f => f.id === tempFileInfo.id);
                            if (index !== -1) {
                                this.compare2UploadedFiles[index].status = 'error';
                            }
                        } else {
                            const index = this.uploadedFiles.findIndex(f => f.id === tempFileInfo.id);
                            if (index !== -1) {
                                this.uploadedFiles[index].status = 'error';
                            }
                        }
                        
                        // Показываем более понятное сообщение об ошибке
                        let errorMessage = data.error;
                        if (data.error === 'Session not found') {
                            errorMessage = 'Сессия не найдена. Попробуйте отправить сообщение сначала.';
                        } else if (data.error === 'Unsupported file type') {
                            errorMessage = 'Неподдерживаемый тип файла. Поддерживаются: .txt, .py, .pdf, .jpg, .jpeg, .png, .gif';
                        } else if (data.error.includes('File too large')) {
                            errorMessage = 'Файл слишком большой. Максимальный размер: 10MB';
                        }
                        
                        this.showNotification(`Ошибка загрузки файла: ${errorMessage}`, 'error');
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    
                    // Обновляем статус на ошибку
                    if (chatType === 'compare') {
                        const index = this.compareUploadedFiles.findIndex(f => f.id === tempFileInfo.id);
                        if (index !== -1) {
                            this.compareUploadedFiles[index].status = 'error';
                        }
                    } else if (chatType === 'compare2') {
                        const index = this.compare2UploadedFiles.findIndex(f => f.id === tempFileInfo.id);
                        if (index !== -1) {
                            this.compare2UploadedFiles[index].status = 'error';
                        }
                    } else {
                        const index = this.uploadedFiles.findIndex(f => f.id === tempFileInfo.id);
                        if (index !== -1) {
                            this.uploadedFiles[index].status = 'error';
                        }
                    }
                    
                    if (error.name === 'AbortError') {
                        this.showNotification(`Таймаут загрузки файла "${file.name}" (30 сек)`, 'warning');
                    } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        this.showNotification(`Ошибка сети при загрузке "${file.name}". Проверьте подключение к интернету.`, 'error');
                    } else {
                        this.showNotification(`Ошибка загрузки файла "${file.name}": ${error.message}`, 'error');
                    }
                }
            }
        },
        
        removeFile(fileId) {
            this.uploadedFiles = this.uploadedFiles.filter(f => f.id !== fileId);
        },
        
        removeCompareFile(fileId) {
            this.compareUploadedFiles = this.compareUploadedFiles.filter(f => f.id !== fileId);
        },
        
        removeCompare2File(fileId) {
            this.compare2UploadedFiles = this.compare2UploadedFiles.filter(f => f.id !== fileId);
        },
        
        // Apply settings to all chats
        applySettingsToBoth() {
            // Применяем настройки ко второму чату
            this.compareSettings = {
                model: this.settings.model,
                temperature: this.settings.temperature,
                top_p: this.settings.top_p,
                max_tokens: this.settings.max_tokens,
                system_prompt: this.settings.system_prompt,
                web_search: this.settings.web_search
            };
            this.compareUploadedFiles = [...this.uploadedFiles];
            
            // Применяем настройки к третьему чату
            this.compare2Settings = {
                model: this.settings.model,
                temperature: this.settings.temperature,
                top_p: this.settings.top_p,
                max_tokens: this.settings.max_tokens,
                system_prompt: this.settings.system_prompt,
                web_search: this.settings.web_search
            };
            this.compare2UploadedFiles = [...this.uploadedFiles];
            
            this.updateAllSessions();
            this.showNotification('Настройки применены ко всем чатам!', 'success');
        },
        
        // Copy settings from Assistant 1 to Assistant 2
        applySettingsFromBoth() {
            this.compareSettings = {
                model: this.settings.model,
                temperature: this.settings.temperature,
                top_p: this.settings.top_p,
                max_tokens: this.settings.max_tokens,
                system_prompt: this.settings.system_prompt,
                web_search: this.settings.web_search
            };
            this.compareUploadedFiles = [...this.uploadedFiles];
            this.updateAllSessions();
            alert('Настройки скопированы из Ассистента 1');
        },
        
        applySettingsFromCompare2() {
            this.compare2Settings = {
                model: this.settings.model,
                temperature: this.settings.temperature,
                top_p: this.settings.top_p,
                max_tokens: this.settings.max_tokens,
                system_prompt: this.settings.system_prompt,
                web_search: this.settings.web_search
            };
            this.compare2UploadedFiles = [...this.uploadedFiles];
            this.updateAllSessions();
            alert('Настройки скопированы из Ассистента 1');
        },
        
        // Save agent from Chat 1
        async checkAgentExists(name) {
            try {
                const response = await fetch('/playground/api/agents/check/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ name: name })
                });
                const data = await response.json();
                return data.exists ? data.agent : null;
            } catch (error) {
                console.error('Error checking agent:', error);
                return null;
            }
        },
        
        async checkAndFillAgent1() {
            if (this.newAgent1.name.trim()) {
                const existingAgent = await this.checkAgentExists(this.newAgent1.name);
                if (existingAgent) {
                    this.newAgent1.description = existingAgent.description;
                }
            }
        },
        
        async checkAndFillAgent2() {
            if (this.newAgent2.name.trim()) {
                const existingAgent = await this.checkAgentExists(this.newAgent2.name);
                if (existingAgent) {
                    this.newAgent2.description = existingAgent.description;
                }
            }
        },
        
        async checkAndFillAgent3() {
            if (this.newAgent3.name.trim()) {
                const existingAgent = await this.checkAgentExists(this.newAgent3.name);
                if (existingAgent) {
                    this.newAgent3.description = existingAgent.description;
                }
            }
        },
        
        async saveAgent1() {
            if (!this.newAgent1.name.trim()) return;
            
            this.isCreatingAgent1 = true;
            try {
                const agentData = {
                    name: this.newAgent1.name,
                    description: this.newAgent1.description,
                    model: this.settings.model,
                    temperature: this.settings.temperature,
                    top_p: this.settings.top_p,
                    max_tokens: this.settings.max_tokens,
                    system_prompt: this.settings.system_prompt
                };
                
                const response = await fetch('/playground/api/agents/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify(agentData)
                });
                
                const data = await response.json();
                if (data.success) {
                    this.currentAgentId = data.agent.id;
                    this.showSaveAgentModal1 = false;
                    this.newAgent1 = { name: '', description: '' };
                    if (data.updated) {
                        this.showNotification('Ассистент "' + data.agent.name + '" успешно обновлен!', 'success');
                    } else {
                        this.showNotification('Ассистент "' + data.agent.name + '" успешно создан!', 'success');
                    }
                } else {
                    this.showNotification('Ошибка сохранения ассистента: ' + data.error, 'error');
                }
            } catch (error) {
                this.showNotification('Ошибка сохранения ассистента: ' + error.message, 'error');
            } finally {
                this.isCreatingAgent1 = false;
            }
        },
        
        // Save agent from Chat 2
        async saveAgent2() {
            if (!this.newAgent2.name.trim()) return;
            
            this.isCreatingAgent2 = true;
            try {
                const agentData = {
                    name: this.newAgent2.name,
                    description: this.newAgent2.description,
                    model: this.compareSettings.model,
                    temperature: this.compareSettings.temperature,
                    top_p: this.compareSettings.top_p,
                    system_prompt: this.compareSettings.system_prompt
                };
                
                const response = await fetch('/playground/api/agents/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify(agentData)
                });
                
                const data = await response.json();
                if (data.success) {
                    this.compareAgentId = data.agent.id;
                    this.showSaveAgentModal2 = false;
                    this.newAgent2 = { name: '', description: '' };
                    if (data.updated) {
                        this.showNotification('Ассистент "' + data.agent.name + '" успешно обновлен!', 'success');
                    } else {
                        this.showNotification('Ассистент "' + data.agent.name + '" успешно создан!', 'success');
                    }
                } else {
                    this.showNotification('Ошибка сохранения ассистента: ' + data.error, 'error');
                }
            } catch (error) {
                this.showNotification('Ошибка сохранения ассистента: ' + error.message, 'error');
            } finally {
                this.isCreatingAgent2 = false;
            }
        },
        
        async saveAgent3() {
            if (!this.newAgent3.name.trim()) return;
            
            this.isCreatingAgent3 = true;
            try {
                const agentData = {
                    name: this.newAgent3.name,
                    description: this.newAgent3.description,
                    model: this.compare2Settings.model,
                    temperature: this.compare2Settings.temperature,
                    top_p: this.compare2Settings.top_p,
                    system_prompt: this.compare2Settings.system_prompt
                };
                
                const response = await fetch('/playground/api/agents/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify(agentData)
                });
                
                const data = await response.json();
                if (data.success) {
                    this.compare2AgentId = data.agent.id;
                    this.showSaveAgentModal3 = false;
                    this.newAgent3 = { name: '', description: '' };
                    if (data.updated) {
                        this.showNotification('Ассистент "' + data.agent.name + '" успешно обновлен!', 'success');
                    } else {
                        this.showNotification('Ассистент "' + data.agent.name + '" успешно создан!', 'success');
                    }
                } else {
                    this.showNotification('Ошибка сохранения ассистента: ' + data.error, 'error');
                }
            } catch (error) {
                this.showNotification('Ошибка сохранения ассистента: ' + error.message, 'error');
            } finally {
                this.isCreatingAgent3 = false;
            }
        },
        
        addFunction() {
            if (!this.newFunction.name || !this.newFunction.jsonDefinition || !this.newFunction.pythonCode) {
                alert('Заполните все обязательные поля');
                return;
            }
            
            try {
                // Проверяем JSON
                const jsonDef = JSON.parse(this.newFunction.jsonDefinition);
                
                // Добавляем функцию в список
                this.currentFunctions.push({
                    name: this.newFunction.name,
                    description: this.newFunction.description,
                    json_definition: jsonDef,
                    python_code: this.newFunction.pythonCode
                });
                
                // Очищаем форму
                this.newFunction = {
                    name: '',
                    description: '',
                    jsonDefinition: '',
                    pythonCode: ''
                };
                
                // Закрываем модальное окно
                this.showAddFunctionModal = false;
                
            } catch (e) {
                alert('Неверный JSON формат в определении функции');
            }
        },
        
        removeFunction(index) {
            this.currentFunctions.splice(index, 1);
        },
        
        clearFunctions() {
            if (confirm('Удалить все функции?')) {
                this.currentFunctions = [];
            }
        },
        
        clearAllFiles() {
            if (confirm('Удалить все загруженные файлы?')) {
                this.uploadedFiles = [];
            }
        },
        
        clearAllCompareFiles() {
            if (confirm('Удалить все загруженные файлы для сравнения?')) {
                this.compareUploadedFiles = [];
            }
        },
        
        clearAllCompare2Files() {
            if (confirm('Удалить все загруженные файлы для сравнения 2?')) {
                this.compare2UploadedFiles = [];
            }
        },
        
        async saveSystemPrompt() {
            // Для основного ассистента создаем ассистента автоматически, если его нет
            if (!this.currentAgentId) {
                try {
                    const response = await fetch('/playground/api/agents/create/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify({
                            name: 'Основной ассистент',
                            description: 'Основной ассистент для чата',
                            model: this.settings.model,
                            temperature: this.settings.temperature,
                            top_p: this.settings.top_p,
                            max_tokens: this.settings.max_tokens,
                            system_prompt: this.settings.system_prompt
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        this.currentAgentId = data.agent.id;
                        this.showNotification('Ассистент создан и системный промпт сохранен', 'success');
                        return;
                    } else {
                        this.showNotification(`Ошибка создания ассистента: ${data.error}`, 'error');
                        return;
                    }
                } catch (error) {
                    this.showNotification('Ошибка создания ассистента: ' + error.message, 'error');
                    return;
                }
            }
            
            try {
                const response = await fetch(`/playground/api/agents/${this.currentAgentId}/update/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        system_prompt: this.settings.system_prompt
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    this.showNotification('Системный промпт сохранен в ассистенте', 'success');
                } else {
                    this.showNotification('Ошибка сохранения: ' + data.error, 'error');
                }
            } catch (error) {
                this.showNotification('Ошибка сохранения: ' + error.message, 'error');
            }
        },
        
        async loadSystemPrompt() {
            if (!this.currentAgentId) {
                this.showNotification('Нет сохраненного ассистента для загрузки', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`/playground/api/agents/${this.currentAgentId}/`);
                const data = await response.json();
                
                if (data.success) {
                    this.settings.system_prompt = data.agent.system_prompt || '';
                    this.showNotification('Системный промпт загружен из ассистента', 'success');
                } else {
                    this.showNotification('Ошибка загрузки: ' + data.error, 'error');
                }
            } catch (error) {
                this.showNotification('Ошибка загрузки: ' + error.message, 'error');
            }
        },
        
        async saveSystemPrompt2() {
            // Если ассистент для сравнения не выбран, создаем его автоматически
            if (!this.compareAgentId) {
                try {
                    const response = await fetch('/playground/api/agents/create/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify({
                            name: 'Ассистент сравнения 1',
                            description: 'Ассистент для сравнения',
                            model: this.compareSettings.model,
                            temperature: this.compareSettings.temperature,
                            top_p: this.compareSettings.top_p,
                            max_tokens: this.compareSettings.max_tokens,
                            system_prompt: this.compareSettings.system_prompt
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        this.compareAgentId = data.agent.id;
                        this.showNotification('Ассистент сравнения создан и системный промпт сохранен', 'success');
                        return;
                    } else {
                        this.showNotification(`Ошибка создания ассистента: ${data.error}`, 'error');
                        return;
                    }
                } catch (error) {
                    this.showNotification('Ошибка создания ассистента: ' + error.message, 'error');
                    return;
                }
            }
            
            try {
                const response = await fetch(`/playground/api/agents/${this.compareAgentId}/update/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        system_prompt: this.compareSettings.system_prompt
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    this.showNotification('Системный промпт сохранен в ассистенте сравнения', 'success');
                } else {
                    this.showNotification('Ошибка сохранения: ' + data.error, 'error');
                }
            } catch (error) {
                this.showNotification('Ошибка сохранения: ' + error.message, 'error');
            }
        },
        
        async loadSystemPrompt2() {
            if (!this.compareAgentId) {
                this.showNotification('Нет сохраненного ассистента сравнения для загрузки', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`/playground/api/agents/${this.compareAgentId}/`);
                const data = await response.json();
                
                if (data.success) {
                    this.compareSettings.system_prompt = data.agent.system_prompt || '';
                    this.showNotification('Системный промпт загружен из ассистента сравнения', 'success');
                } else {
                    this.showNotification('Ошибка загрузки: ' + data.error, 'error');
                }
            } catch (error) {
                this.showNotification('Ошибка загрузки: ' + error.message, 'error');
            }
        },
        
        async saveSystemPrompt3() {
            // Если ассистент для сравнения не выбран, создаем его автоматически
            if (!this.compare2AgentId) {
                try {
                    const response = await fetch('/playground/api/agents/create/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify({
                            name: 'Ассистент сравнения 2',
                            description: 'Ассистент для сравнения',
                            model: this.compare2Settings.model,
                            temperature: this.compare2Settings.temperature,
                            top_p: this.compare2Settings.top_p,
                            max_tokens: this.compare2Settings.max_tokens,
                            system_prompt: this.compare2Settings.system_prompt
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        this.compare2AgentId = data.agent.id;
                        this.showNotification('Ассистент сравнения 2 создан и системный промпт сохранен', 'success');
                        return;
                    } else {
                        this.showNotification(`Ошибка создания ассистента: ${data.error}`, 'error');
                        return;
                    }
                } catch (error) {
                    this.showNotification('Ошибка создания ассистента: ' + error.message, 'error');
                    return;
                }
            }
            
            try {
                const response = await fetch(`/playground/api/agents/${this.compare2AgentId}/update/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        system_prompt: this.compare2Settings.system_prompt
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    this.showNotification('Системный промпт сохранен в ассистенте сравнения 2', 'success');
                } else {
                    this.showNotification('Ошибка сохранения: ' + data.error, 'error');
                }
            } catch (error) {
                this.showNotification('Ошибка сохранения: ' + error.message, 'error');
            }
        },
        
        async loadSystemPrompt3() {
            if (!this.compare2AgentId) {
                this.showNotification('Нет сохраненного ассистента сравнения 2 для загрузки', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`/playground/api/agents/${this.compare2AgentId}/`);
                const data = await response.json();
                
                if (data.success) {
                    this.compare2Settings.system_prompt = data.agent.system_prompt || '';
                    this.showNotification('Системный промпт загружен из ассистента сравнения 2', 'success');
                } else {
                    this.showNotification('Ошибка загрузки: ' + data.error, 'error');
                }
            } catch (error) {
                this.showNotification('Ошибка загрузки: ' + error.message, 'error');
            }
        },
        
        // Функции для очистки системных промптов
        clearSystemPrompt() {
            this.settings.system_prompt = '';
            this.updateAllSessions();
            this.showNotification('Системный промпт очищен', 'info');
        },
        
        clearSystemPrompt2() {
            this.compareSettings.system_prompt = '';
            this.updateAllSessions();
            this.showNotification('Системный промпт второго чата очищен', 'info');
        },
        
        clearSystemPrompt3() {
            this.compare2Settings.system_prompt = '';
            this.updateAllSessions();
            this.showNotification('Системный промпт третьего чата очищен', 'info');
        },
        
        init() {
            // Инициализируем ChatManager
            this.chatManager = ChatFactory.createChatManager(this.getCSRFToken());
            
            // Синхронизируем состояние поиска
            this.allWebSearchEnabled = this.settings.web_search;
            this.compareWebSearchEnabled = this.compareSettings.web_search;
            this.compare2WebSearchEnabled = this.compare2Settings.web_search;
            
            // Создаем сессии для всех чатов
            this.chatManager.createChatSession('main', ChatFactory.createSettings(
                this.settings.model,
                this.settings.temperature,
                this.settings.top_p,
                this.settings.max_tokens,
                this.settings.system_prompt,
                this.settings.web_search,
                this.currentFunctions
            ));
            
            this.chatManager.createChatSession('compare', ChatFactory.createSettings(
                this.compareSettings.model,
                this.compareSettings.temperature,
                this.compareSettings.top_p,
                this.compareSettings.max_tokens,
                this.compareSettings.system_prompt,
                this.compareSettings.web_search,
                this.currentFunctions
            ));
            
            this.chatManager.createChatSession('compare2', ChatFactory.createSettings(
                this.compare2Settings.model,
                this.compare2Settings.temperature,
                this.compare2Settings.top_p,
                this.compare2Settings.max_tokens,
                this.compare2Settings.system_prompt,
                this.compare2Settings.web_search,
                this.currentFunctions
            ));
            
            // Загружаем ассистента из URL параметров
            const urlParams = new URLSearchParams(window.location.search);
            const assistantId = urlParams.get('assistant');
            if (assistantId) {
                this.loadAssistant(assistantId);
            }
        },
        
        async loadAssistant(assistantId) {
            try {
                const response = await fetch(`/playground/api/agents/${assistantId}/`);
                const data = await response.json();
                
                if (data.success) {
                    const agent = data.agent;
                    this.currentAgentId = agent.id;
                    this.settings.model = agent.model;
                    this.settings.temperature = agent.temperature;
                    this.settings.top_p = agent.top_p;
                    this.settings.max_tokens = agent.max_tokens;
                    this.settings.system_prompt = agent.system_prompt || '';
                    this.settings.web_search = agent.web_search || false;
                    
                    // Синхронизируем состояние поиска
                    this.allWebSearchEnabled = this.settings.web_search;
                    
                    this.showNotification(`Загружен ассистент: ${agent.name}`, 'success');
                } else {
                    this.showNotification('Ошибка загрузки ассистента: ' + data.error, 'error');
                }
            } catch (error) {
                this.showNotification('Ошибка загрузки ассистента: ' + error.message, 'error');
            }
        }
    }
}
</script>

<!-- Подключаем ChatManager -->
<script src="{% static 'js/chat-manager.js' %}"></script>
{% endblock %}